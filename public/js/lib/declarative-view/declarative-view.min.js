!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(jQuery):window.DeclarativeView=t(jQuery)}(function(t){function e(){this.events={},this.listeners=[]}function r(e){if(r.parent.apply(this,arguments),e=e||{},this.id=r.nextId(),this.wrappers={sources:[],targets:[]},this.node=t(e.node||this.node||"<div>"),e.parent&&(this.parent=e.parent),e.wrappers){var n=e.wrappers;this.wrappers.sources=[].concat(n.sources),this.wrappers.targets=[].concat(n.targets)}this.data=I({object:this,prop:"data",deep:!1}),e.data&&k(this.data,e.data),this.ui=I({object:this,prop:"ui",deep:!1}),e.ui&&k(this.ui,e.ui),this.template=I({object:this,prop:"template",deep:!0}),e.template&&E(this.template,e.template);for(var i in this.ui)this.ui.hasOwnProperty(i)&&q(this,i);r.helpers.template(this,"",this.template)}function n(t,e,i){for(var o in i){if(!i.hasOwnProperty(o))return;var s=i[o];"function"==typeof s&&(s=s.call(t)),"&"===o.charAt(0)?o=o.slice(1):e&&(o=" "+o);for(var a in s)if(s.hasOwnProperty(a))if("&"!==a.charAt(0))r.helpers[a](t,e+o,s[a]);else{var f={};f[a]=s[a],n(t,e+o,f)}}}function i(t,e,r){m({view:t,node:t.find(e),method:"toggleClass",options:r,wrapper:function(t){return!!t}})}function o(t,e,r){m({view:t,node:t.find(e),method:"attr",options:r})}function s(t,e,r){m({view:t,node:t.find(e),method:"prop",options:r})}function a(t,e,r){m({view:t,node:t.find(e),method:"css",options:r})}function f(t,e,r){w({view:t,node:t.find(e),method:"html",options:r})}function c(t,e,r){w({view:t,node:t.find(e),method:"text",options:r,wrapper:function(t){return null===t||void 0===t?"":t}})}function p(t,e,r,n){function i(e){var r="!"===e.charAt(0);return r&&(e=e.slice(1)),function(n){r&&n.preventDefault(),e&&t[e].apply(t,arguments)}}var o=t.find(e);n=!!n;for(var s in r)if(r.hasOwnProperty(s)){var a=r[s];switch(typeof a){case"function":t.listenOn(o,s,a,n);break;case"object":for(var f in a)if(a.hasOwnProperty(f)){var c=a[f];"string"==typeof c&&(c=i(c)),t.listenOn(o,s,f,c,n)}break;case"string":t.listenOn(o,s,i(a),n)}}}function h(t,e,r){p(t,e,r,!0)}function u(t,e,r){p(t,e,{click:r})}function l(t,e,r){function n(e,r){var n="change";e.indexOf("|")>-1&&(e=e.split("|"),n=e[1],e=e[0]);var o=r;r.indexOf(".")>-1&&(o=r.split(".")),t.listenOn(i,n,function(){t.set(o,i.prop(e))}),t.on("@"+r,function(t){t!==i.prop(e)&&i.prop(e,t)})}var i=t.find(e);for(var o in r)r.hasOwnProperty(o)&&n(o,r[o])}function v(t,e,r){m({view:t,node:t.find(e),method:"css",options:{display:r},wrapper:function(t){return t?"":"none"}})}function d(t,e,r){m({view:t,node:t.find(e),method:"css",options:{display:r},wrapper:function(t){return t?"none":""}})}function g(e,n,i){function o(t,n){var o,s;if(D(i.view))o=i.view;else if(i.view){var a=i.view.call(e,t,d&&d.clone());D(a)?o=a:s=a}else o=r;if(o){var f={},h=null;i.dataProp?(f[i.dataProp]=t,"object"==typeof t&&null!==t&&(h={sources:[t],targets:[u.modelOf(t)]})):"object"==typeof t&&null!==t?k(f,t):f.value=t,i.dataIndexProp&&(f[i.dataIndexProp]=n),s=new o({node:d&&d.clone(),parent:e,data:f,wrappers:h,template:i.template})}s.parent=s.parent||e,s.context=s.context||t,l.add(s,n),i.add?i.add.call(e,p,s,n):0===n?1===l.length()?p.append(s.node):s.node.insertBefore(l.get(1).node):s.node.insertAfter(l.get(n-1).node),i.dataIndexProp&&c()}function s(t,r){i.remove?i.remove.call(e,p,l.get(r),r):l.get(r).remove(),l.removeAt(r),i.dataIndexProp&&c()}function a(t,r,n){if(l.moveFrom(n,r),i.move)i.move.call(e,p,l.get(r),r,n);else{var o=l.get(r).node;0===r?1===l.length()?o.appendTo(p):o.insertBefore(l.get(1).node):o.insertAfter(l.get(r-1).node)}i.dataIndexProp&&c()}function f(){i.sort?i.sort.call(e,p,l):u.forEach(function(t,e){var r=l.indexByContext(t);e!==r&&a(t,e,r)}),i.dataIndexProp&&c()}function c(){l.forEach(function(t,e){t.set(i.dataIndexProp,e)})}var p=e.find(n),h=i.prop,u=e.model("string"==typeof h&&h.indexOf(".")>-1?h.split("."):h),l=new P([]),v=!1!==i.node&&(i.node||"> *"),d=!1===v?null:"string"==typeof v&&"<"!==v.charAt(0)?p.find(v):t(v);d&&(d.detach(),i.removeClass&&d.removeClass(i.removeClass)),u.views=u.views||l,e.views=e.views||{},u.views[n]=e.views[n]=l,e.listenOn(u,"add",o),e.listenOn(u,"remove",s),e.listenOn(u,"move",a),e.listenOn(u,"sort",f),u.forEach(o)}function w(t){function e(e,n){r.on(e,function(){t.value=n?n.apply(r,arguments):arguments[0],y(t)})}var r=t.view,n=t.options;switch(t=k({},t),typeof n){case"string":e(n);break;case"object":if(null===n)break;for(var i in n)n.hasOwnProperty(i)&&null!==n[i]&&e(i,n[i]);break;case"function":t.value=n.call(r),y(t);break;default:throw new Error("Unknown options type "+typeof n+" in view class "+r.constructor.name)}}function y(e){var r=e.view,n=e.node,i=e.method,o=e.firstArgument,s=e.value,a=e.wrapper;if(a&&"function"!=typeof s&&(s=a(s)),"function"==typeof s){var f,c=s;a&&(c=function(t,e){return a(s.call(r,t,e))}),f=o?function(t,e){t[i](o,c.call(r,t,e))}:function(t,e){t[i](c.call(r,t,e))};for(var p=0,h=n.length;p<h;p++)f(t(n[p]),p)}else o?n[i](o,s):n[i](s)}function m(t){var e=t.options;for(var r in e)e.hasOwnProperty(r)&&(t.firstArgument=r,t.options=e[r],w(t))}function O(t){e.call(this),this.context=t}function x(t,e,r){O.call(this,r),this.view=t,this.path=e,this.on("set",function(t,e,r){var n=this.view.wrappers.sources.indexOf(r);-1!==n&&this.view.wrappers.targets[n].clear()})}function b(){O.apply(this,arguments)}function A(t,e,r){x.apply(this,arguments),this.on("remove",function(t){var e=this.view.wrappers.sources.indexOf(t);-1!==e&&this.view.wrappers.targets[e].clear()})}function P(){b.apply(this,arguments)}function j(t,e,r){"function"==typeof this&&(r=arguments[0]||{},e=this,t=r.hasOwnProperty("constructor")?r.constructor:function(){e.apply(this,arguments)});var n=t.prototype;if(Object.create)t.prototype=Object.create(e.prototype);else{var i=function(){};i.prototype=r,t.prototype=new i}return k(t.prototype,n),t.prototype.constructor=t,k(t.prototype,r),t.extend=e.extend,t.parent=e,t.__super__=e.prototype,t}function k(t){for(var e=1,r=arguments.length;e<r;e++){var n=arguments[e];for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])}return t}function E(t){for(var e=1,r=arguments.length;e<r;e++){var n=arguments[e];for(var i in n)n.hasOwnProperty(i)&&(t[i]=t[i]&&n[i]&&"object"==typeof t[i]&&"object"==typeof n[i]?E(t[i],n[i]):n[i])}return t}function I(t){var e=Object.getPrototypeOf(t.object);if(e){var r=!t.list;if(r&&(t.context=t.object,t.list=[]),t.list.push(e[t.prop]),t.object=e,I(t),r){for(var n=t.list,i=t.deep?E:k,o={},s=n.length-1;s>=0;s--){var a=n[s];i(o,"function"==typeof a?a.call(t.context,i):t.deep?C(a):a)}return o}}}function C(t){var e={};for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];e[r]=n&&"object"==typeof n?C(n):n}return e}function W(t,e){var r=t.indexOf(e);-1!==r&&t.splice(r,1)}function L(t,e){for(var r=0,n=t.length;r<n;r++)if(e(t[r],r))return t[r]}function B(t){return t[t.length-1]}function _(t){return"object"==typeof t?t:t.indexOf(" ")>-1?t.split(/\s+/):[t]}function F(t,e){return t.length>e?Array.prototype.slice.call(t,e):[]}function T(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function q(e,r){var n=e.ui[r];if("string"==typeof n){if("<"===n.charAt(0))return e.ui[r]=t(n);var i="uiSelector"+e.id;n=n.replace(/@(\w+)/g,function(t,r){return q(e,r)[i]}),e.ui[r]=n?e.node.find(n):e.node,e.ui[r][i]=n}return e.ui[r]}function D(t){return"function"==typeof t&&"function"==typeof t.extend}function Q(t,e){for(var r=t,n=0,i=e.length-1;n<i;n++)r=r.model(e[n]);var o=B(e),s=r.get(o);return s&&"object"==typeof s&&(r=r.model(o)),r}function S(t,e){return 0===e||t>=e?-1:t<0?S(e+t,e):t}function N(t,e){t=[].concat(t);for(var r=0,n=t.length;r<n;r++)t[r]=S(t[r],e);return t}k(e,{extend:j}),k(e.prototype,{on:function(t,e,r,n){t=_(t),"boolean"==typeof r&&(n=r,r=null);var i=this;return t.forEach(function(t){if(t){var o,s=e,a=!1,f=!1,c=!1;if("!"===t.charAt(0)&&(a=!0,t=t.slice(1)),"="===t.charAt(0)?f=!0:"@"===t.charAt(0)&&(c=!0),(f||c)&&(o=t.slice(1).split(".")),(a||o)&&(s=function(t){var n=o?i.get(o):t;a&&(n=!n);var s=[n];arguments.length>0&&(s=s.concat(F(arguments,a||o&&arguments[0]!==n?0:1))),e.apply(r||i,s)}),(f||c)&&s(i.get(o)),!f){if(c){var p=Q(i,o);if(i!==p)return t=p instanceof b?"change":"set/"+B(o),void i.listenOn(p,t,s);t="set/"+o.join(".")}var h=i.events[t];h||(h=i.events[t]=[]),h.push({once:n,context:r,callback:e,wrapper:s})}}}),this},once:function(t,e,r){return this.on(t,e,r,!0)},off:function(t,e){if(0===arguments.length)return this.events={},this;t=_(t);for(var r=0,n=t.length;r<n;r++){var i=t[r],o=this.events[i];if(o)if(e){for(var s=0,a=o.length;s<a;s++)if(o[s].callback===e){o.splice(s,1);break}0===o.length&&delete this.events[i]}else delete this.events[i]}return this},trigger:function(t){var e=this.events[t];if(!e)return this;for(var r=F(arguments,1),n=0,i=e.length;n<i;n++){var o=e[n];o.once&&(e.splice(n,1),n--,i--),o.wrapper.apply(o.context||this,r)}return 0===e.length&&delete this.events[t],this},listenTo:function(t){var e=this,r=t.target,n=t.events,i=t.callback,o=t.once,s=L(this.listeners,function(t){return t.target===r});return s||(s={target:r,off:t.off,events:{}},this.listeners.push(s)),n=_(n),n.forEach(function(n){var a=s.events[n];a||(a=s.events[n]=[]);var f=function(){return o&&e.stopListening(r,n,i),i.apply(e,arguments)};a.push({origin:i,wrapper:f}),t.on(r,n,f)}),this},stopListening:function(t,e,r){var n;if(t&&!(n=L(this.listeners,function(e){return e.target===t})))return this;switch(e&&(e=_(e)),arguments.length){case 0:for(var i=this.listeners.length-1;i>-1;i--)this.stopListening(this.listeners[i].target);break;case 1:for(var o in n.events)n.events.hasOwnProperty(o)&&n.events[o].forEach(function(e){n.off(t,o,e.wrapper)});W(this.listeners,n);break;case 2:e.forEach(function(r){n.events.hasOwnProperty(r)&&(n.events[r].forEach(function(e){n.off(t,r,e.wrapper)}),delete n.events[e])});break;case 3:e.forEach(function(e){var i=n.events[e];i&&(i.forEach(function(o){o.origin===r&&(n.off(t,e,o.wrapper),W(i,o))}),0===i.length&&delete n.events[e])})}return n&&T(n.events)&&W(this.listeners,n),this},listenOn:function(t,e,r){var n=F(arguments,1),i=!1;return r=B(n),"boolean"==typeof r&&(i=r,n.pop(),r=B(n)),this.listenTo({target:t,events:e,callback:r,once:i,on:function(t,e,r){n[0]=e,n[n.length-1]=r,t.on.apply(t,n)},off:function(t,e,r){var n;n=r?[e,r]:e?[e]:[],t.off.apply(t,n)}})},listenOnce:function(t,e,r){var n=F(arguments,0);return n.push(!0),this.listenOn.apply(this,n)}}),k(r,{$:t,ObjectWrapper:O,ArrayWrapper:b,currentId:0,nextId:function(){return++this.currentId}}),j(r,e,{ui:{root:""},get:function(t){if(0===arguments.length)return this.data;if(t instanceof Array){for(var e=this,r=0,n=t.length-1;r<n;r++)e=e.model(t[r]);return e.get(t[n])}return this.data[t]},set:function(t,e){if(t instanceof Array){return Q(this,t).set(B(t),e),this}if("object"==typeof t){for(var r in t)t.hasOwnProperty(r)&&this.set(r,t[r]);return this}var n=this.get(t);if(n===e)return this;var i=this.wrappers.sources.indexOf(n);return-1!==i&&this.wrappers.targets[i].clear(),this.data[t]=e,this.trigger("set/"+t,e,n),this.trigger("set",t,e,n),this},has:function(t){return this.data.hasOwnProperty(t)},model:function(t){if(t instanceof Array){for(var e=this,r=0,n=t.length;r<n;r++)e=e.model(t[r]);return e}var i=this.get(t),o=this.wrappers.sources.indexOf(i);if(-1===o){var s=this.wrapper(i,[t]);if(!s)return;this.wrappers.targets.push(s),o=this.wrappers.sources.push(i)-1}return this.wrappers.targets[o]},modelOf:function(t){var e=this.wrappers.sources.indexOf(t);return this.wrappers.targets[e]},assign:function(t,e){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r],i=this.has(r);(i||"defaults"!==e)&&(i&&n&&"object"==typeof n?this.model(r).assign(n,e):this.set(r,n))}},wrapper:function(t,e){if(t&&"object"==typeof t){return new(t instanceof Array?A:x)(this,e,t)}},find:function(t){var e=t.indexOf("@");if(0===e){var r=t.slice(1);if(this.ui.hasOwnProperty(r))return this.ui[r]}if(e>-1){var n=this,i="uiSelector"+n.id;t=t.replace(/@(\w+)/,function(t,e){return q(n,e)[i]})}return t?this.node.find(t):this.node},remove:function(){return this.stopListening(),this.off(),this.node.remove(),this}}),r.helpers={template:n,class:i,toggleClass:i,attr:o,prop:s,style:a,css:a,html:f,text:c,on:p,once:h,click:u,connect:l,visible:v,show:v,hidden:d,hide:d,each:g};var U={model:function(t){var e=this.get(t),r=this.view.wrappers.sources.indexOf(e);if(-1===r){var n=this.view.wrapper(e,this.path.concat(t));if(!n)return;this.view.wrappers.targets.push(n),r=this.view.wrappers.sources.push(e)-1}return this.view.wrappers.targets[r]},assign:r.prototype.assign,clear:function(){var t=this.view.wrappers.sources.indexOf(this.context);if(-1!==t){var e=this.view.wrappers.targets[t];this.view.stopListening(e),this.view.wrappers.sources.splice(t,1),this.view.wrappers.targets.splice(t,1)}var r=this.get();for(var n in r)r.hasOwnProperty(n)&&-1!==(t=this.view.wrappers.sources.indexOf(r[n]))&&this.view.wrappers.targets[t].clear();this.view=this.path=this.context=null}};return j(O,e,{get:function(t){return 0===arguments.length?this.context:this.context[t]},set:function(t,e){if("object"==typeof t){for(var r in t)t.hasOwnProperty(r)&&this.set(r,t[r]);return this}var n=this.get(t);return n===e?this:(this.context[t]=e,this.trigger("set/"+t,e,n),this.trigger("set",t,e,n),this)},has:function(t){return this.context.hasOwnProperty(t)}}),j(x,O,U),Object.getOwnPropertyNames(Array.prototype).forEach(function(t){b.prototype[t]||"function"!=typeof Array.prototype[t]||(b.prototype[t]=function(){return Array.prototype[t].apply(this.context,arguments)})}),b.prototype.find||(b.prototype.find=function(t){return L(this.context,t)}),j(b,O,{length:function(){return this.context.length},add:function(t,e){t instanceof Array==!1&&(t=[t]);var r=this.context,n=this.length();0===n?e=0:e>n||void 0===e?e=n:e<0&&(e=S(e,n));for(var i=0,o=t.length;i<o;i++){var s=t[i],a=e+i;a>=this.length()?r.push(s):r.splice(a,0,s),this.trigger("add",s,a),this.trigger("change","add",s,a)}return this},remove:function(t){if(t instanceof Array){for(var e=0,r=t.length;e<r;e++)this.remove(t[e]);return this}return this.removeAt(this.indexOf(t)),this},removeAt:function(t){var e=this.length();if(0===e)return this;if(t instanceof Array){for(var r=N(t,e),n=0,i=r.length;n<i;n++)this.removeAt(r[n]);return this}if(-1===(t=S(t,e)))return this;var o=this.context,s=this.get(t);return t+1===e?o.pop():0===t?o.shift():o.splice(t,1),this.trigger("remove",s,t),this.trigger("change","remove",s,t),this},removeAll:function(){for(var t=this.length()-1;t>-1;t--)this.removeAt(t);return this},replace:function(t,e){return this.replaceAt(this.indexOf(t),e)},replaceAt:function(t,e){return this.removeAt(t),this.add(e,t),this},move:function(t,e){return this.moveFrom(this.indexOf(t),e)},moveFrom:function(t,e){var r=this.length();if(r<2||t>=r)return this;if(t=S(t,r),e=e>=r?r-1:S(e,r),t===e)return this;var n=this.get(t);return this.context.splice(t,1),this.context.splice(e,0,n),this.trigger("move",n,e,t),this.trigger("change","move",n,e,t),this},sort:function(t){return this.context.sort(t),this.trigger("sort"),this.trigger("change","sort"),this},reset:function(t){return this.removeAll(),this.add(t),this},filterWhere:function(t){return this.filter(function(e){for(var r in t)if(t.hasOwnProperty(r)&&e[r]!==t[r])return!1;return!0})},findWhere:function(t){return this.find(function(e){for(var r in t)if(t.hasOwnProperty(r)&&e[r]!==t[r])return!1;return!0})}}),j(A,b,k({},U,{modelOf:function(t){return this.model(this.indexOf(t))},assign:function(t){return this.reset(t)}})),j(P,b,{indexByContext:function(t){for(var e=this.context,r=0,n=e.length;r<n;r++)if(e[r].context===t)return r},viewOf:function(t){for(var e=this.context,r=0,n=e.length;r<n;r++)if(e[r].context===t)return e[r]}}),r.EventEmitter=e,r.ObjectWrapper=O,r.ArrayWrapper=b,r});