!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(jQuery):window.DeclarativeView=t(jQuery)}(function(t){function e(){this.events={},this.listeners=[]}function r(e){if(r.parent.apply(this,arguments),e=e||{},this.id=r.nextId(),this.wrappers={sources:[],targets:[]},this.node=t(e.node||this.node||"<div>"),e.parent&&(this.parent=e.parent),e.wrappers){var n=e.wrappers;this.wrappers.sources=[].concat(n.sources),this.wrappers.targets=[].concat(n.targets)}this.data=P({object:this,prop:"data",deep:!1}),e.data&&A(this.data,e.data),this.ui=P({object:this,prop:"ui",deep:!1}),e.ui&&A(this.ui,e.ui),this.template=P({object:this,prop:"template",deep:!0}),e.template&&j(this.template,e.template);for(var i in this.ui)this.ui.hasOwnProperty(i)&&F(this,i);r.helpers.template(this,"",this.template)}function n(t,e,i){for(var o in i){if(!i.hasOwnProperty(o))return;var s=i[o];"&"===o.charAt(0)?o=o.slice(1):e&&(o=" "+o);for(var a in s)if(s.hasOwnProperty(a))if("&"!==a.charAt(0))r.helpers[a](t,e+o,s[a]);else{var f={};f[a]=s[a],n(t,e+o,f)}}}function i(t,e,r){g({view:t,node:t.find(e),method:"toggleClass",options:r,wrapper:function(t){return!!t}})}function o(t,e,r){g({view:t,node:t.find(e),method:"attr",options:r})}function s(t,e,r){g({view:t,node:t.find(e),method:"prop",options:r})}function a(t,e,r){g({view:t,node:t.find(e),method:"css",options:r})}function f(t,e,r){v({view:t,node:t.find(e),method:"html",options:r})}function c(t,e,r){v({view:t,node:t.find(e),method:"text",options:r,wrapper:function(t){return null===t||void 0===t?"":t}})}function p(t,e,r,n){function i(e){var r="!"===e.charAt(0);return r&&(e=e.slice(1)),function(n){r&&n.preventDefault(),e&&t[e].apply(t,arguments)}}var o=t.find(e);n=!!n;for(var s in r)if(r.hasOwnProperty(s)){var a=r[s];switch(typeof a){case"function":t.listenOn(o,s,a,n);break;case"object":for(var f in a)if(a.hasOwnProperty(f)){var c=a[f];"string"==typeof c&&(c=i(c)),t.listenOn(o,s,f,c,n)}break;case"string":t.listenOn(o,s,i(a),n)}}}function h(t,e,r){p(t,e,r,!0)}function u(t,e,r){function n(e,r){var n="change";e.indexOf("|")>-1&&(e=e.split("|"),n=e[1],e=e[0]),t.listenOn(i,n,function(){t.set(r,i.prop(e))}),t.on("@"+r,function(t){t!==i.prop(e)&&i.prop(e,t)})}var i=t.find(e);for(var o in r)r.hasOwnProperty(o)&&n(o,r[o])}function l(e,n,i){function o(t,n){var o,s;if(T(i.view))o=i.view;else if(i.view){var a=i.view.call(e,t,l.clone());T(a)?o=a:s=a}else o=r;if(o){var f={},u=null;i.viewProp?(f[i.viewProp]=t,"object"==typeof t&&null!==t&&(u={sources:[t],targets:[p.modelOf(t)]})):"object"==typeof t&&null!==t?A(f,t):f.value=t,s=new o({node:l.clone(),parent:e,data:f,wrappers:u,template:i.template})}if(s.parent=s.parent||e,s.context=s.context||t,h.add(s,n),i.add)return void i.add.call(e,c,s,n);0===n?1===h.length()?c.append(s.node):s.node.insertBefore(h.get(1).node):s.node.insertAfter(h.get(n-1).node)}function s(t,r){i.remove?i.remove.call(e,c,h.get(r),r):h.get(r).remove(),h.removeAt(r)}function a(t,r,n){if(h.moveFrom(n,r),i.move)return void i.move.call(e,c,h.get(r),r,n);var o=h.get(r).node;0===r?1===h.length()?o.appendTo(c):o.insertBefore(h.get(1).node):o.insertAfter(h.get(r-1).node)}function f(){if(i.sort)return void i.sort.call(e,c,h);p.forEach(function(t,e){var r=h.indexByContext(t);e!==r&&a(t,e,r)})}var c=e.find(n),p=e.model(i.prop),h=new x([]),u=!1===i.node?[]:i.node||"> *",l="string"==typeof u&&"<"!==u.charAt(0)?c.find(u):t(u);l.detach(),p.views=p.views||{},e.views=e.views||{},p.views[n]=e.views[n]=h,e.listenOn(p,"add",o),e.listenOn(p,"remove",s),e.listenOn(p,"move",a),e.listenOn(p,"sort",f),p.forEach(o)}function v(t){function e(e,n){r.on(e,function(){t.value=n?n.apply(r,arguments):arguments[0],d(t)})}var r=t.view,n=t.options;switch(t=A({},t),typeof n){case"string":e(n);break;case"object":if(null===n)break;for(var i in n)n.hasOwnProperty(i)&&null!==n[i]&&e(i,n[i]);break;case"function":t.value=n.call(r),d(t);break;default:throw new Error("Unknown options type")}}function d(e){var r=e.view,n=e.node,i=e.method,o=e.firstArgument,s=e.value,a=e.wrapper;if("function"==typeof s){var f,c=s;a&&(c=function(t,e){return a(s.call(r,t,e))}),f=o?function(t,e){t[i](o,c.call(r,t,e))}:function(t,e){t[i](c.call(r,t,e))};for(var p=0,h=n.length;p<h;p++)f(t(n[p]),p)}else o?n[i](o,s):n[i](s)}function g(t){var e=t.options;for(var r in e)e.hasOwnProperty(r)&&(t.firstArgument=r,t.options=e[r],v(t))}function w(t){e.call(this),this.context=t}function y(t,e,r){w.call(this,r),this.view=t,this.path=e,this.on("set",function(t,e,r){var n=this.view.wrappers.sources.indexOf(r);-1!==n&&this.view.wrappers.targets[n].clear()})}function m(){w.apply(this,arguments)}function O(t,e,r){y.apply(this,arguments),this.on("remove",function(t){var e=this.view.wrappers.sources.indexOf(t);-1!==e&&this.view.wrappers.targets[e].clear()})}function x(){m.apply(this,arguments)}function b(t,e,r){"function"==typeof this&&(r=arguments[0]||{},e=this,t=r.hasOwnProperty("constructor")?r.constructor:function(){e.apply(this,arguments)});var n=t.prototype;if(Object.create)t.prototype=Object.create(e.prototype);else{var i=function(){};i.prototype=r,t.prototype=new i}return A(t.prototype,n),t.prototype.constructor=t,A(t.prototype,r),t.extend=e.extend,t.parent=e,t.__super__=e.prototype,t}function A(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function j(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=t[r]&&e[r]&&"object"==typeof t[r]&&"object"==typeof e[r]?j(t[r],e[r]):e[r]);return t}function P(t){var e=Object.getPrototypeOf(t.object);if(e){var r=!t.list;if(r&&(t.context=t.object,t.list=[]),t.list.push(e[t.prop]),t.object=e,P(t),r){for(var n=t.list,i=t.deep?j:A,o={},s=n.length-1;s>=0;s--){var a=n[s];i(o,"function"==typeof a?a.call(t.context,i):t.deep?k(a):a)}return o}}}function k(t){var e={};for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];e[r]=n&&"object"==typeof n?k(n):n}return e}function E(t,e){var r=t.indexOf(e);-1!==r&&t.splice(r,1)}function L(t,e){for(var r=0,n=t.length;r<n;r++)if(e(t[r],r))return t[r]}function B(t){return t[t.length-1]}function C(t){return"object"==typeof t?t:t.indexOf(" ")>-1?t.split(/\s+/):[t]}function I(t,e){return t.length>e?Array.prototype.slice.call(t,e):[]}function _(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function F(e,r){var n=e.ui[r];if("string"==typeof n){if("<"===n.charAt(0))return e.ui[r]=t(n);var i="uiSelector"+e.id;n=n.replace(/@(\w+)/g,function(t,r){return F(e,r)[i]}),e.ui[r]=n?e.node.find(n):e.node,e.ui[r][i]=n}return e.ui[r]}function T(t){return"function"==typeof t&&"function"==typeof t.extend}function q(t,e){for(var r=t,n=0,i=e.length-1;n<i;n++)r=r.model(e[n]);return r}function D(t,e){return 0===e||t>=e?-1:t<0?D(e+t,e):t}function Q(t,e){t=[].concat(t);for(var r=0,n=t.length;r<n;r++)t[r]=D(t[r],e);return t}A(e,{extend:b}),A(e.prototype,{on:function(t,e,r,n){t=C(t),"boolean"==typeof r&&(n=r,r=null);var i=this;return t.forEach(function(t){if(t){var o,s=e,a=!1,f=!1,c=!1;if("!"===t.charAt(0)&&(a=!0,t=t.slice(1)),"="===t.charAt(0)?(f=!0,o=t.slice(1)):"@"===t.charAt(0)&&(c=!0,o=t.slice(1),t="set/"+o),(f||c)&&o.indexOf(".")>-1&&(o=o.split(".")),(a||o)&&(s=function(t){var n=o?i.get(o):t;a&&(n=!n);var s=[n];arguments.length>0&&(s=s.concat(I(arguments,o&&!a?1:0))),e.apply(r||i,s)}),(f||c)&&s(i.get(o)),!f){var p=i.events[t];p||(p=i.events[t]=[]),p.push({once:n,context:r,callback:e,wrapper:s}),o instanceof Array&&i.listenOn(q(i,o),"set/"+B(o),s)}}}),this},once:function(t,e,r){return this.on(t,e,r,!0)},off:function(t,e){if(0===arguments.length)return this.events={},this;t=C(t);for(var r=0,n=t.length;r<n;r++){var i=t[r],o=this.events[i];if(o)if(e){for(var s=0,a=o.length;s<a;s++)if(o[s].callback===e){o.splice(s,1);break}0===o.length&&delete this.events[i]}else delete this.events[i]}return this},trigger:function(t){var e=this.events[t];if(!e)return this;for(var r=I(arguments,1),n=0,i=e.length;n<i;n++){var o=e[n];o.once&&(e.splice(n,1),n--,i--),o.wrapper.apply(o.context||this,r)}return 0===e.length&&delete this.events[t],this},listenTo:function(t){var e=this,r=t.target,n=t.events,i=t.callback,o=t.once,s=L(this.listeners,function(t){return t.target===r});return s||(s={target:r,off:t.off,events:{}},this.listeners.push(s)),n=C(n),n.forEach(function(n){var a=s.events[n];a||(a=s.events[n]=[]);var f=function(){return o&&e.stopListening(r,n,i),i.apply(e,arguments)};a.push({origin:i,wrapper:f}),t.on(r,n,f)}),this},stopListening:function(t,e,r){var n;if(t&&!(n=L(this.listeners,function(e){return e.target===t})))return this;switch(e&&(e=C(e)),arguments.length){case 0:for(var i=this.listeners.length-1;i>-1;i--)this.stopListening(this.listeners[i].target);break;case 1:for(var o in n.events)n.events.hasOwnProperty(o)&&n.events[o].forEach(function(e){n.off(t,o,e.wrapper)});E(this.listeners,n);break;case 2:e.forEach(function(r){n.events.hasOwnProperty(r)&&(n.events[r].forEach(function(e){n.off(t,r,e.wrapper)}),delete n.events[e])});break;case 3:e.forEach(function(e){var i=n.events[e];i&&(i.forEach(function(o){o.origin===r&&(n.off(t,e,o.wrapper),E(i,o))}),0===i.length&&delete n.events[e])})}return n&&_(n.events)&&E(this.listeners,n),this},listenOn:function(t,e,r){var n=I(arguments,1),i=!1;return r=B(n),"boolean"==typeof r&&(i=r,n.pop(),r=B(n)),this.listenTo({target:t,events:e,callback:r,once:i,on:function(t,e,r){n[0]=e,n[n.length-1]=r,t.on.apply(t,n)},off:function(t,e,r){var n;n=r?[e,r]:e?[e]:[],t.off.apply(t,n)}})},listenOnce:function(t,e,r){var n=I(arguments,0);return n.push(!0),this.listenOn.apply(this,n)}}),A(r,{$:t,ObjectWrapper:w,ArrayWrapper:m,currentId:0,nextId:function(){return++this.currentId}}),b(r,e,{ui:{root:""},get:function(t){if(0===arguments.length)return this.data;if(t instanceof Array){for(var e=this,r=0,n=t.length-1;r<n;r++)e=e.model(t[r]);return e.get(t[n])}return this.data[t]},set:function(t,e){if(t instanceof Array){return q(this,t).set(B(t),e),this}if("object"==typeof t){for(var r in t)t.hasOwnProperty(r)&&this.set(r,t[r]);return this}var n=this.get(t);if(n===e)return this;var i=this.wrappers.sources.indexOf(n);return-1!==i&&this.wrappers.targets[i].clear(),this.data[t]=e,this.trigger("set/"+t,e,n),this.trigger("set",t,e,n),this},model:function(t){if(t instanceof Array){for(var e=this,r=0,n=t.length;r<n;r++)e=e.model(t[r]);return e}var i=this.get(t),o=this.wrappers.sources.indexOf(i);if(-1===o){var s=this.wrapper(i,[t]);if(!s)return;this.wrappers.targets.push(s),o=this.wrappers.sources.push(i)-1}return this.wrappers.targets[o]},modelOf:function(t){var e=this.wrappers.sources.indexOf(t);return this.wrappers.targets[e]},wrapper:function(t,e){if(t&&"object"==typeof t){return new(t instanceof Array?O:y)(this,e,t)}},find:function(t){var e=t.indexOf("@");if(0===e){var r=t.slice(1);if(this.ui.hasOwnProperty(r))return this.ui[r]}if(e>-1){var n=this,i="uiSelector"+n.id;t=t.replace(/@(\w+)/,function(t,e){return F(n,e)[i]})}return t?this.node.find(t):this.node},remove:function(){return this.stopListening(),this.off(),this.node.remove(),this}}),r.helpers={template:n,class:i,toggleClass:i,attr:o,prop:s,style:a,css:a,html:f,text:c,on:p,once:h,connect:u,each:l},b(w,e,{get:function(t){return 0===arguments.length?this.context:this.context[t]},set:function(t,e){if("object"==typeof t){for(var r in t)t.hasOwnProperty(r)&&this.set(r,t[r]);return this}var n=this.get(t);return n===e?this:(this.context[t]=e,this.trigger("set/"+t,e,n),this.trigger("set",t,e,n),this)}});var S={model:function(t){var e=this.get(t),r=this.view.wrappers.sources.indexOf(e);if(-1===r){var n=this.view.wrapper(e,this.path.concat(t));if(!n)return;this.view.wrappers.targets.push(n),r=this.view.wrappers.sources.push(e)-1}return this.view.wrappers.targets[r]},clear:function(){var t=this.view.wrappers.sources.indexOf(this.context);if(-1!==t){var e=this.view.wrappers.targets[t];this.view.stopListening(e),this.view.wrappers.sources.splice(t,1),this.view.wrappers.targets.splice(t,1)}var r=this.get();for(var n in r)r.hasOwnProperty(n)&&-1!==(t=this.view.wrappers.sources.indexOf(r[n]))&&this.view.wrappers.targets[t].clear();this.view=this.path=this.context=null}};return b(y,w,S),Object.getOwnPropertyNames(Array.prototype).forEach(function(t){m.prototype[t]||"function"!=typeof Array.prototype[t]||(m.prototype[t]=function(){return Array.prototype[t].apply(this.context,arguments)})}),m.prototype.find||(m.prototype.find=function(t){return L(this.context,t)}),b(m,w,{length:function(){return this.context.length},add:function(t,e){t instanceof Array==!1&&(t=[t]);var r=this.context,n=this.length();0===n?e=0:e>n||void 0===e?e=n:e<0&&(e=D(e,n));for(var i=0,o=t.length;i<o;i++){var s=t[i],a=e+i;a>=this.length()?r.push(s):r.splice(a,0,s),this.trigger("add",s,a)}return this},remove:function(t){if(t instanceof Array){for(var e=0,r=t.length;e<r;e++)this.remove(t[e]);return this}return this.removeAt(this.indexOf(t)),this},removeAt:function(t){var e=this.length();if(0===e)return this;if(t instanceof Array){for(var r=Q(t,e),n=0,i=r.length;n<i;n++)this.removeAt(r[n]);return this}if(-1===(t=D(t,e)))return this;var o=this.context,s=this.get(t);return t+1===e?o.pop():0===t?o.shift():o.splice(t,1),this.trigger("remove",s,t),this},removeAll:function(){for(var t=this.length()-1;t>-1;t--)this.removeAt(t);return this},replace:function(t,e){return this.replaceAt(this.indexOf(t),e)},replaceAt:function(t,e){return this.removeAt(t),this.add(e,t),this},move:function(t,e){return this.moveFrom(this.indexOf(t),e)},moveFrom:function(t,e){var r=this.length();if(r<2||t>=r)return this;if(t=D(t,r),e=e>=r?r-1:D(e,r),t===e)return this;var n=this.get(t);return this.context.splice(t,1),this.context.splice(e,0,n),this.trigger("move",n,e,t),this},sort:function(t){return this.context.sort(t),this.trigger("sort"),this},reset:function(t){return this.removeAll(),this.add(t),this}}),b(O,m,S),O.prototype.modelOf=function(t){return this.model(this.indexOf(t))},b(x,m,{indexByContext:function(t){for(var e=this.context,r=0,n=e.length;r<n;r++)if(e[r].context===t)return r}}),r});