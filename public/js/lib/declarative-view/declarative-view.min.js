!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(jQuery):window.DeclarativeView=t(jQuery)}(function(t){function e(){this.events={},this.listeners=[]}function n(e){if(n.parent.apply(this,arguments),e=e||{},this.id=n.nextId(),this.wrappers={sources:[],targets:[]},this.node=t(e.node||this.node||"<div>"),e.parent&&(this.parent=e.parent),e.wrappers){var r=e.wrappers;this.wrappers.sources=[].concat(r.sources),this.wrappers.targets=[].concat(r.targets)}this.data=L({object:this,prop:"data",deep:!1}),e.data&&k(this.data,e.data),this.ui=L({object:this,prop:"ui",deep:!1}),e.ui&&k(this.ui,e.ui),this.template=L({object:this,prop:"template",deep:!0}),e.template&&E(this.template,e.template);for(var i in this.ui)this.ui.hasOwnProperty(i)&&D(this,i);n.helpers.template(this,"",this.template)}function r(t,e,i){for(var o in i){if(!i.hasOwnProperty(o))return;var s=i[o];"function"==typeof s&&(s=s.call(t)),"&"===o.charAt(0)?o=o.slice(1):e&&(o=" "+o);for(var a in s)if(s.hasOwnProperty(a))if("&"!==a.charAt(0))n.helpers[a](t,e+o,s[a]);else{var f={};f[a]=s[a],r(t,e+o,f)}}}function i(t,e,n){m({view:t,node:t.find(e),method:"toggleClass",options:n,wrapper:function(t){return!!t}})}function o(t,e,n){m({view:t,node:t.find(e),method:"attr",options:n})}function s(t,e,n){m({view:t,node:t.find(e),method:"prop",options:n})}function a(t,e,n){m({view:t,node:t.find(e),method:"css",options:n})}function f(t,e,n){w({view:t,node:t.find(e),method:"html",options:n})}function c(t,e,n){w({view:t,node:t.find(e),method:"text",options:n,wrapper:function(t){return null===t||void 0===t?"":t}})}function p(t,e,n,r){function i(e){var n="!"===e.charAt(0);return n&&(e=e.slice(1)),function(r){n&&r.preventDefault(),e&&t[e].apply(t,arguments)}}var o=t.find(e);r=!!r;for(var s in n)if(n.hasOwnProperty(s)){var a=n[s];switch(typeof a){case"function":t.listenOn(o,s,a,r);break;case"object":for(var f in a)if(a.hasOwnProperty(f)){var c=a[f];"string"==typeof c&&(c=i(c)),t.listenOn(o,s,f,c,r)}break;case"string":t.listenOn(o,s,i(a),r)}}}function h(t,e,n){p(t,e,n,!0)}function u(t,e,n){p(t,e,{click:n})}function l(t,e,n){function r(e,n){var r="change";e.indexOf("|")>-1&&(e=e.split("|"),r=e[1],e=e[0]);var o=n;n.indexOf(".")>-1&&(o=n.split(".")),t.listenOn(i,r,function(){t.set(o,i.prop(e))}),t.on("@"+n,function(t){t!==i.prop(e)&&i.prop(e,t)})}var i=t.find(e);for(var o in n)n.hasOwnProperty(o)&&r(o,n[o])}function v(t,e,n){m({view:t,node:t.find(e),method:"css",options:{display:n},wrapper:function(t){return t?"":"none"}})}function d(t,e,n){m({view:t,node:t.find(e),method:"css",options:{display:n},wrapper:function(t){return t?"none":""}})}function g(e,r,i){function o(t,r){var o,s;if(Q(i.view))o=i.view;else if(i.view){var a=i.view.call(e,t,v&&v.clone());Q(a)?o=a:s=a}else o=n;if(o){var f={},p=null;i.dataProp?(f[i.dataProp]=t,"object"==typeof t&&null!==t&&(p={sources:[t],targets:[h.modelOf(t)]})):"object"==typeof t&&null!==t?k(f,t):f.value=t,s=new o({node:v&&v.clone(),parent:e,data:f,wrappers:p,template:i.template})}if(s.parent=s.parent||e,s.context=s.context||t,u.add(s,r),i.add)return void i.add.call(e,c,s,r);0===r?1===u.length()?c.append(s.node):s.node.insertBefore(u.get(1).node):s.node.insertAfter(u.get(r-1).node)}function s(t,n){i.remove?i.remove.call(e,c,u.get(n),n):u.get(n).remove(),u.removeAt(n)}function a(t,n,r){if(u.moveFrom(r,n),i.move)return void i.move.call(e,c,u.get(n),n,r);var o=u.get(n).node;0===n?1===u.length()?o.appendTo(c):o.insertBefore(u.get(1).node):o.insertAfter(u.get(n-1).node)}function f(){if(i.sort)return void i.sort.call(e,c,u);h.forEach(function(t,e){var n=u.indexByContext(t);e!==n&&a(t,e,n)})}var c=e.find(r),p=i.prop,h=e.model("string"==typeof p&&p.indexOf(".")>-1?p.split("."):p),u=new j([]),l=!1!==i.node&&(i.node||"> *"),v=!1===l?null:"string"==typeof l&&"<"!==l.charAt(0)?c.find(l):t(l);v&&v.detach(),h.views=h.views||u,e.views=e.views||{},h.views[r]=e.views[r]=u,e.listenOn(h,"add",o),e.listenOn(h,"remove",s),e.listenOn(h,"move",a),e.listenOn(h,"sort",f),h.forEach(o)}function w(t){function e(e,r){n.on(e,function(){t.value=r?r.apply(n,arguments):arguments[0],y(t)})}var n=t.view,r=t.options;switch(t=k({},t),typeof r){case"string":e(r);break;case"object":if(null===r)break;for(var i in r)r.hasOwnProperty(i)&&null!==r[i]&&e(i,r[i]);break;case"function":t.value=r.call(n),y(t);break;default:throw new Error("Unknown options type "+typeof r+" in view class "+n.constructor.name)}}function y(e){var n=e.view,r=e.node,i=e.method,o=e.firstArgument,s=e.value,a=e.wrapper;if(a&&"function"!=typeof s&&(s=a(s)),"function"==typeof s){var f,c=s;a&&(c=function(t,e){return a(s.call(n,t,e))}),f=o?function(t,e){t[i](o,c.call(n,t,e))}:function(t,e){t[i](c.call(n,t,e))};for(var p=0,h=r.length;p<h;p++)f(t(r[p]),p)}else o?r[i](o,s):r[i](s)}function m(t){var e=t.options;for(var n in e)e.hasOwnProperty(n)&&(t.firstArgument=n,t.options=e[n],w(t))}function O(t){e.call(this),this.context=t}function x(t,e,n){O.call(this,n),this.view=t,this.path=e,this.on("set",function(t,e,n){var r=this.view.wrappers.sources.indexOf(n);-1!==r&&this.view.wrappers.targets[r].clear()})}function b(){O.apply(this,arguments)}function A(t,e,n){x.apply(this,arguments),this.on("remove",function(t){var e=this.view.wrappers.sources.indexOf(t);-1!==e&&this.view.wrappers.targets[e].clear()})}function j(){b.apply(this,arguments)}function P(t,e,n){"function"==typeof this&&(n=arguments[0]||{},e=this,t=n.hasOwnProperty("constructor")?n.constructor:function(){e.apply(this,arguments)});var r=t.prototype;if(Object.create)t.prototype=Object.create(e.prototype);else{var i=function(){};i.prototype=n,t.prototype=new i}return k(t.prototype,r),t.prototype.constructor=t,k(t.prototype,n),t.extend=e.extend,t.parent=e,t.__super__=e.prototype,t}function k(t){for(var e=1,n=arguments.length;e<n;e++){var r=arguments[e];for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])}return t}function E(t){for(var e=1,n=arguments.length;e<n;e++){var r=arguments[e];for(var i in r)r.hasOwnProperty(i)&&(t[i]=t[i]&&r[i]&&"object"==typeof t[i]&&"object"==typeof r[i]?E(t[i],r[i]):r[i])}return t}function L(t){var e=Object.getPrototypeOf(t.object);if(e){var n=!t.list;if(n&&(t.context=t.object,t.list=[]),t.list.push(e[t.prop]),t.object=e,L(t),n){for(var r=t.list,i=t.deep?E:k,o={},s=r.length-1;s>=0;s--){var a=r[s];i(o,"function"==typeof a?a.call(t.context,i):t.deep?B(a):a)}return o}}}function B(t){var e={};for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];e[n]=r&&"object"==typeof r?B(r):r}return e}function C(t,e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}function I(t,e){for(var n=0,r=t.length;n<r;n++)if(e(t[n],n))return t[n]}function _(t){return t[t.length-1]}function F(t){return"object"==typeof t?t:t.indexOf(" ")>-1?t.split(/\s+/):[t]}function T(t,e){return t.length>e?Array.prototype.slice.call(t,e):[]}function q(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function D(e,n){var r=e.ui[n];if("string"==typeof r){if("<"===r.charAt(0))return e.ui[n]=t(r);var i="uiSelector"+e.id;r=r.replace(/@(\w+)/g,function(t,n){return D(e,n)[i]}),e.ui[n]=r?e.node.find(r):e.node,e.ui[n][i]=r}return e.ui[n]}function Q(t){return"function"==typeof t&&"function"==typeof t.extend}function S(t,e){for(var n=t,r=0,i=e.length-1;r<i;r++)n=n.model(e[r]);var o=_(e),s=n.get(o);return s&&"object"==typeof s&&(n=n.model(o)),n}function W(t,e){return 0===e||t>=e?-1:t<0?W(e+t,e):t}function N(t,e){t=[].concat(t);for(var n=0,r=t.length;n<r;n++)t[n]=W(t[n],e);return t}k(e,{extend:P}),k(e.prototype,{on:function(t,e,n,r){t=F(t),"boolean"==typeof n&&(r=n,n=null);var i=this;return t.forEach(function(t){if(t){var o,s=e,a=!1,f=!1,c=!1;if("!"===t.charAt(0)&&(a=!0,t=t.slice(1)),"="===t.charAt(0)?f=!0:"@"===t.charAt(0)&&(c=!0),(f||c)&&(o=t.slice(1).split(".")),(a||o)&&(s=function(t){var r=o?i.get(o):t;a&&(r=!r);var s=[r];arguments.length>0&&(s=s.concat(T(arguments,a||o&&arguments[0]!==r?0:1))),e.apply(n||i,s)}),(f||c)&&s(i.get(o)),!f){if(c){var p=S(i,o);if(i!==p)return t=p instanceof b?"change":"set/"+_(o),void i.listenOn(p,t,s);t="set/"+o.join(".")}var h=i.events[t];h||(h=i.events[t]=[]),h.push({once:r,context:n,callback:e,wrapper:s})}}}),this},once:function(t,e,n){return this.on(t,e,n,!0)},off:function(t,e){if(0===arguments.length)return this.events={},this;t=F(t);for(var n=0,r=t.length;n<r;n++){var i=t[n],o=this.events[i];if(o)if(e){for(var s=0,a=o.length;s<a;s++)if(o[s].callback===e){o.splice(s,1);break}0===o.length&&delete this.events[i]}else delete this.events[i]}return this},trigger:function(t){var e=this.events[t];if(!e)return this;for(var n=T(arguments,1),r=0,i=e.length;r<i;r++){var o=e[r];o.once&&(e.splice(r,1),r--,i--),o.wrapper.apply(o.context||this,n)}return 0===e.length&&delete this.events[t],this},listenTo:function(t){var e=this,n=t.target,r=t.events,i=t.callback,o=t.once,s=I(this.listeners,function(t){return t.target===n});return s||(s={target:n,off:t.off,events:{}},this.listeners.push(s)),r=F(r),r.forEach(function(r){var a=s.events[r];a||(a=s.events[r]=[]);var f=function(){return o&&e.stopListening(n,r,i),i.apply(e,arguments)};a.push({origin:i,wrapper:f}),t.on(n,r,f)}),this},stopListening:function(t,e,n){var r;if(t&&!(r=I(this.listeners,function(e){return e.target===t})))return this;switch(e&&(e=F(e)),arguments.length){case 0:for(var i=this.listeners.length-1;i>-1;i--)this.stopListening(this.listeners[i].target);break;case 1:for(var o in r.events)r.events.hasOwnProperty(o)&&r.events[o].forEach(function(e){r.off(t,o,e.wrapper)});C(this.listeners,r);break;case 2:e.forEach(function(n){r.events.hasOwnProperty(n)&&(r.events[n].forEach(function(e){r.off(t,n,e.wrapper)}),delete r.events[e])});break;case 3:e.forEach(function(e){var i=r.events[e];i&&(i.forEach(function(o){o.origin===n&&(r.off(t,e,o.wrapper),C(i,o))}),0===i.length&&delete r.events[e])})}return r&&q(r.events)&&C(this.listeners,r),this},listenOn:function(t,e,n){var r=T(arguments,1),i=!1;return n=_(r),"boolean"==typeof n&&(i=n,r.pop(),n=_(r)),this.listenTo({target:t,events:e,callback:n,once:i,on:function(t,e,n){r[0]=e,r[r.length-1]=n,t.on.apply(t,r)},off:function(t,e,n){var r;r=n?[e,n]:e?[e]:[],t.off.apply(t,r)}})},listenOnce:function(t,e,n){var r=T(arguments,0);return r.push(!0),this.listenOn.apply(this,r)}}),k(n,{$:t,ObjectWrapper:O,ArrayWrapper:b,currentId:0,nextId:function(){return++this.currentId}}),P(n,e,{ui:{root:""},get:function(t){if(0===arguments.length)return this.data;if(t instanceof Array){for(var e=this,n=0,r=t.length-1;n<r;n++)e=e.model(t[n]);return e.get(t[r])}return this.data[t]},set:function(t,e){if(t instanceof Array){return S(this,t).set(_(t),e),this}if("object"==typeof t){for(var n in t)t.hasOwnProperty(n)&&this.set(n,t[n]);return this}var r=this.get(t);if(r===e)return this;var i=this.wrappers.sources.indexOf(r);return-1!==i&&this.wrappers.targets[i].clear(),this.data[t]=e,this.trigger("set/"+t,e,r),this.trigger("set",t,e,r),this},has:function(t){return this.data.hasOwnProperty(t)},model:function(t){if(t instanceof Array){for(var e=this,n=0,r=t.length;n<r;n++)e=e.model(t[n]);return e}var i=this.get(t),o=this.wrappers.sources.indexOf(i);if(-1===o){var s=this.wrapper(i,[t]);if(!s)return;this.wrappers.targets.push(s),o=this.wrappers.sources.push(i)-1}return this.wrappers.targets[o]},modelOf:function(t){var e=this.wrappers.sources.indexOf(t);return this.wrappers.targets[e]},assign:function(t,e){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n],i=this.has(n);(i||"defaults"!==e)&&(i&&r&&"object"==typeof r?this.model(n).assign(r,e):this.set(n,r))}},wrapper:function(t,e){if(t&&"object"==typeof t){return new(t instanceof Array?A:x)(this,e,t)}},find:function(t){var e=t.indexOf("@");if(0===e){var n=t.slice(1);if(this.ui.hasOwnProperty(n))return this.ui[n]}if(e>-1){var r=this,i="uiSelector"+r.id;t=t.replace(/@(\w+)/,function(t,e){return D(r,e)[i]})}return t?this.node.find(t):this.node},remove:function(){return this.stopListening(),this.off(),this.node.remove(),this}}),n.helpers={template:r,class:i,toggleClass:i,attr:o,prop:s,style:a,css:a,html:f,text:c,on:p,once:h,click:u,connect:l,visible:v,show:v,hidden:d,hide:d,each:g};var U={model:function(t){var e=this.get(t),n=this.view.wrappers.sources.indexOf(e);if(-1===n){var r=this.view.wrapper(e,this.path.concat(t));if(!r)return;this.view.wrappers.targets.push(r),n=this.view.wrappers.sources.push(e)-1}return this.view.wrappers.targets[n]},assign:n.prototype.assign,clear:function(){var t=this.view.wrappers.sources.indexOf(this.context);if(-1!==t){var e=this.view.wrappers.targets[t];this.view.stopListening(e),this.view.wrappers.sources.splice(t,1),this.view.wrappers.targets.splice(t,1)}var n=this.get();for(var r in n)n.hasOwnProperty(r)&&-1!==(t=this.view.wrappers.sources.indexOf(n[r]))&&this.view.wrappers.targets[t].clear();this.view=this.path=this.context=null}};return P(O,e,{get:function(t){return 0===arguments.length?this.context:this.context[t]},set:function(t,e){if("object"==typeof t){for(var n in t)t.hasOwnProperty(n)&&this.set(n,t[n]);return this}var r=this.get(t);return r===e?this:(this.context[t]=e,this.trigger("set/"+t,e,r),this.trigger("set",t,e,r),this)},has:function(t){return this.context.hasOwnProperty(t)}}),P(x,O,U),Object.getOwnPropertyNames(Array.prototype).forEach(function(t){b.prototype[t]||"function"!=typeof Array.prototype[t]||(b.prototype[t]=function(){return Array.prototype[t].apply(this.context,arguments)})}),b.prototype.find||(b.prototype.find=function(t){return I(this.context,t)}),P(b,O,{length:function(){return this.context.length},add:function(t,e){t instanceof Array==!1&&(t=[t]);var n=this.context,r=this.length();0===r?e=0:e>r||void 0===e?e=r:e<0&&(e=W(e,r));for(var i=0,o=t.length;i<o;i++){var s=t[i],a=e+i;a>=this.length()?n.push(s):n.splice(a,0,s),this.trigger("add",s,a),this.trigger("change","add",s,a)}return this},remove:function(t){if(t instanceof Array){for(var e=0,n=t.length;e<n;e++)this.remove(t[e]);return this}return this.removeAt(this.indexOf(t)),this},removeAt:function(t){var e=this.length();if(0===e)return this;if(t instanceof Array){for(var n=N(t,e),r=0,i=n.length;r<i;r++)this.removeAt(n[r]);return this}if(-1===(t=W(t,e)))return this;var o=this.context,s=this.get(t);return t+1===e?o.pop():0===t?o.shift():o.splice(t,1),this.trigger("remove",s,t),this.trigger("change","remove",s,t),this},removeAll:function(){for(var t=this.length()-1;t>-1;t--)this.removeAt(t);return this},replace:function(t,e){return this.replaceAt(this.indexOf(t),e)},replaceAt:function(t,e){return this.removeAt(t),this.add(e,t),this},move:function(t,e){return this.moveFrom(this.indexOf(t),e)},moveFrom:function(t,e){var n=this.length();if(n<2||t>=n)return this;if(t=W(t,n),e=e>=n?n-1:W(e,n),t===e)return this;var r=this.get(t);return this.context.splice(t,1),this.context.splice(e,0,r),this.trigger("move",r,e,t),this.trigger("change","move",r,e,t),this},sort:function(t){return this.context.sort(t),this.trigger("sort"),this.trigger("change","sort"),this},reset:function(t){return this.removeAll(),this.add(t),this}}),P(A,b,k({},U,{modelOf:function(t){return this.model(this.indexOf(t))},assign:function(t){return this.reset(t)}})),P(j,b,{indexByContext:function(t){for(var e=this.context,n=0,r=e.length;n<r;n++)if(e[n].context===t)return n},viewOf:function(t){for(var e=this.context,n=0,r=e.length;n<r;n++)if(e[n].context===t)return e[n]}}),n});