!function(t){"function"==typeof define&&define.amd?define(["declarative-view","jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(require("declarative-view"),jQuery):window.ComponentComposer=t(DeclarativeView,jQuery)}(function(t,o){function n(o){t.call(this,o)}function e(n){t.call(this,n),this.window=o(window),this.documentBody=o(document.body),this.listenOn(this.ui.dragZone,"mousedown",this.validateDragging)}function i(t){e.call(this,t)}function r(t){this.composer=t.parent&&t.parent.composer||t.parent,e.call(this,t)}function a(){r.apply(this,arguments)}return t.extend({constructor:n,data:function(){return{arrow:{visible:!1,direction:"vertical",top:0,left:0,component:null,index:0},toolbar:[],components:[],componentsDirection:"vertical",componentsProp:"components",componentDataProp:"component",componentTypeProp:"type"}},ui:{arrow:"> [data-arrow]",toolbar:"> [data-toolbar]",components:"> [data-components]"},forEachComponent:function(t){function o(n,e){if(!1!==t(n,e)){var i=n.views&&n.views["@components"];i&&i.forEach(o)}}this.views["@components"].forEach(o)},updateComponentsPositions:function(){function t(t){var o=t.offset();return o.width=t.outerWidth(),o.height=t.outerHeight(),o.bottom=o.top+o.height,o.right=o.left+o.width,o.middle=o.top+o.height/2,o.center=o.left+o.width/2,o}function o(o){var n=t(o);return n.innerTop=n.top+parseInt(o.css("padding-top")),n.innerLeft=n.left+parseInt(o.css("padding-left")),n}var n=[];if(0===this.data[this.data.componentsProp].length){var e=o(this.ui.components);e.container=!0,e.component=this,e.direction=this.data.componentsDirection,n.push(e)}this.forEachComponent(function(e,i){var r=t(e.node);r.component=e,r.index=i,r.direction=e.parent.data.componentsDirection,n.push(r);var a=e.data.componentsProp,p=a&&e.get(a);if(p&&0===p.length){var s=o(e.ui.components);s.container=!0,s.component=e,s.direction=e.data.componentsDirection,n.push(s)}}),this.componentsPositions=n},updateArrow:function(t){for(var o=this.componentsPositions,n=this.model("arrow"),e=o.length-1;e>-1;e--){var i=o[e];if(i.container){if(t.top>=i.top&&t.top<=i.bottom&&t.left>=i.left&&t.left<=i.right)return void n.set({direction:i.direction,top:i.innerTop,left:i.innerLeft,visible:i.component!==t.component,component:null,parent:i.component,index:0})}else if("vertical"===i.direction){if(t.left<i.left||t.left>i.right)continue;if(t.top>=i.top&&t.top<i.middle)return void n.set({direction:i.direction,top:i.top,left:i.left,visible:i.component!==t.component,component:i.component,parent:i.component.parent,index:i.index});if(t.top>=i.middle&&t.top<=i.bottom)return void n.set({direction:i.direction,top:i.bottom,left:i.left,visible:i.component!==t.component,component:i.component,parent:i.component.parent,index:i.index+1})}else if("horizontal"===i.direction){if(t.top<i.top||t.top>i.bottom)continue;if(t.left>=i.left&&t.left<i.center)return void n.set({direction:i.direction,top:i.top,left:i.left,visible:i.component!==t.component,component:i.component,parent:i.component.parent,index:i.index});if(t.left>=i.center&&t.left<=i.right)return void n.set({direction:i.direction,top:i.top,left:i.right,visible:i.component!==t.component,component:i.component,parent:i.component.parent,index:i.index+1})}}n.set({visible:!1,component:null,parent:null,index:-1})},onToolbarItemStartDragging:function(){this.updateComponentsPositions()},onToolbarItemDragging:function(t){this.updateArrow(t.get("position"))},onToolbarItemStopDragging:function(t){this.componentsPositions=null;var o=this.model("arrow");if(o.get("visible")){o.set("visible",!1);var n=o.get("parent");n.model(n.data.componentsProp).add(this.getComponentData(t.data.type),o.get("index"))}},onComponentStartDragging:function(){this.updateComponentsPositions()},onComponentDragging:function(t){var o=t.get("position");this.updateArrow({top:o.top,left:o.left,component:t})},onComponentStopDragging:function(t){this.componentsPositions=null;var o=this.model("arrow");if(o.get("visible")){o.set("visible",!1);var n=o.get("parent"),e=t.parent,i=n.model(n.data.componentsProp),r=t.data[e.data.componentDataProp],a=o.get("index");i.indexOf(r)!==a&&(e===n?i.move(r,a):(e.model(e.data.componentsProp).remove(r),i.add(r,a)))}},getComponentView:function(t){var o=this.data.componentTypeProp,n=t[o];if(!n)throw new Error("Undefined prop "+JSON.stringify(o));for(var e,i=this.data.types,r=0;e=i[r];r++)if(e.id===n)return"function"==typeof e?e:e.view;throw new Error("Unknown type "+JSON.stringify(n))},getComponentData:function(t){return t.data()},template:function(){return{"@arrow":{style:{top:"@arrow.top",left:"@arrow.left",display:{"@arrow.visible":function(t){return t?"block":"none"}}},attr:{"data-direction":"@arrow.direction"}},"@toolbar":{each:{prop:"types",view:i,dataProp:"type"}},"@components":{each:{prop:this.data.componentsProp,view:this.getComponentView,dataProp:this.data.componentDataProp,node:!1}}}}}),t.extend({constructor:e,ui:{dragZone:"[data-drag-zone]",dragClone:"[data-drag-clone]"},data:function(){return{dragging:!1,offset:{left:10,top:10},position:{left:0,top:0}}},validateDragging:function(t){1===t.which&&this.onStartDragging(t)},onStartDragging:function(t){this.model("position").set({top:t.pageY-this.data.offset.top,left:t.pageX-this.data.offset.left}),this.ui.dragClone.appendTo(this.documentBody),this.listenOn(this.documentBody,"mousemove.startDragging",this.onDragging),this.listenOn(this.documentBody,"mouseup.startDragging",this.onStopDragging),this.set("dragging",!0)},onDragging:function(t){this.model("position").set({top:t.pageY-this.data.offset.top,left:t.pageX-this.data.offset.left})},onStopDragging:function(){this.ui.dragClone.appendTo(this.node),this.stopListening(this.window,"scroll.startDragging"),this.stopListening(this.documentBody,"mousemove.startDragging"),this.stopListening(this.documentBody,"mouseup.startDragging"),this.set("dragging",!1)},template:function(){var t={},o="@dragClone";return 0===this.ui.dragClone.length&&(o="@root"),t[o]={style:{left:"@position.left",top:"@position.top"}},t}}),e.extend({constructor:i,ui:{title:"[data-title]",dragZone:"@root"},onStartDragging:function(t){var o=this.ui.dragZone.offset();this.model("offset").set({top:t.pageY-o.top,left:t.pageX-o.left}),e.prototype.onStartDragging.call(this,t),this.parent.onToolbarItemStartDragging(this)},onDragging:function(t){e.prototype.onDragging.call(this,t),this.parent.onToolbarItemDragging(this)},onStopDragging:function(t){e.prototype.onStopDragging.call(this,t),this.parent.onToolbarItemStopDragging(this)},template:{"@title":{text:"=type.title"}}}),e.extend({constructor:r,onStartDragging:function(t){e.prototype.onStartDragging.call(this,t),this.composer.onComponentStartDragging(this)},onDragging:function(t){e.prototype.onDragging.call(this,t),this.composer.onComponentDragging(this)},onStopDragging:function(t){e.prototype.onStopDragging.call(this,t),this.composer.onComponentStopDragging(this)}}),r.extend({constructor:a,ui:{components:"[data-components]"},data:{componentsProp:["component","components"],componentDataProp:"component",componentsDirection:"vertical"},forEachComponent:n.prototype.forEachComponent,template:function(){return{"@components":{each:{prop:this.data.componentsProp,view:function(t){return this.composer.getComponentView(t)},dataProp:this.data.componentDataProp,node:!1}}}}}),n.Draggable=e,n.ToolbarItem=i,n.Component=r,n.ContainerComponent=a,n});