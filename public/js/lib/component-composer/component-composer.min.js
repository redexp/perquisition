!function(t){"function"==typeof define&&define.amd?define(["declarative-view","jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(require("declarative-view"),jQuery):window.ComponentComposer=t(DeclarativeView,jQuery)}(function(t,o){function n(n){t.call(this,n),this.window=o(window),this.documentBody=o(document.body),this.listenOn(this.documentBody,"keydown",this.validatePasteStartDragging)}function e(n){t.call(this,n),this.window=o(window),this.documentBody=o(document.body),this.listenOn(this.ui.dragZone,"mousedown",this.validateDragging)}function i(t){e.call(this,t)}function a(t){e.call(this,t)}function r(){a.apply(this,arguments)}n.CUT_KEY="ComponentComposer:cut",t.extend({constructor:n,data:function(){return{arrow:{visible:!1,direction:"vertical",top:0,left:0,component:null,index:0},toolbar:[],components:[],componentsDirection:"vertical"}},ui:{arrow:"> [data-arrow]",toolbar:"> [data-toolbar]",components:"> [data-components]",copyTextarea:'<textarea style="position: fixed; left: -1000px;">'},forEachComponent:function(t){function o(n,e){!1!==t(n,e)&&n.data.components&&n.data.components.length>0&&n.data.components.forEach(function(t,n){o(t,n)})}this.data.components.forEach(function(t,n){o(t,n)})},updateComponentsPositions:function(t){function o(t){var o=t.offset();return o.width=t.outerWidth(),o.height=t.outerHeight(),o.bottom=o.top+o.height,o.right=o.left+o.width,o.middle=o.top+o.height/2,o.center=o.left+o.width/2,o}function n(t){var n=o(t);return n.innerTop=n.top+parseInt(t.css("padding-top")),n.innerLeft=n.left+parseInt(t.css("padding-left")),n}t=t||{};var e=[],i=t.exclude;if(0===this.data.components.length){var a=n(this.ui.components);a.container=!0,a.component=this,a.direction=this.data.componentsDirection,e.push(a)}this.forEachComponent(function(t,a){if(t===i)return!1;var r=o(t.node);if(r.component=t,r.index=a,r.direction=t.parent.data.componentsDirection,e.push(r),t.data.components&&t.ui.components&&0===t.data.components.length){var s=n(t.ui.components);s.container=!0,s.component=t,s.direction=t.data.componentsDirection,e.push(s)}}),this.componentsPositions=e},updateArrow:function(t){for(var o=this.componentsPositions,n=this.model("arrow"),e=o.length-1;e>-1;e--){var i=o[e];if(i.container){if(t.top>=i.top&&t.top<=i.bottom&&t.left>=i.left&&t.left<=i.right)return void n.set({direction:i.direction,top:i.innerTop,left:i.innerLeft,visible:!0,component:null,parent:i.component,index:0})}else if("vertical"===i.direction){if(t.left<i.left||t.left>i.right)continue;if(t.top>=i.top&&t.top<i.middle)return void n.set({direction:i.direction,top:i.top,left:i.left,visible:!0,component:i.component,parent:i.component.parent,index:i.index});if(t.top>=i.middle&&t.top<=i.bottom)return void n.set({direction:i.direction,top:i.bottom,left:i.left,visible:!0,component:i.component,parent:i.component.parent,index:i.index+1})}else if("horizontal"===i.direction){if(t.top<i.top||t.top>i.bottom)continue;if(t.left>=i.left&&t.left<i.center)return void n.set({direction:i.direction,top:i.top,left:i.left,visible:!0,component:i.component,parent:i.component.parent,index:i.index});if(t.left>=i.center&&t.left<=i.right)return void n.set({direction:i.direction,top:i.top,left:i.right,visible:!0,component:i.component,parent:i.component.parent,index:i.index+1})}}n.set({visible:!1,component:null,parent:null,index:-1})},onToolbarItemStartDragging:function(){this.updateComponentsPositions()},onToolbarItemDragging:function(t){this.updateArrow(t.get("position"))},onToolbarItemStopDragging:function(t){this.componentsPositions=null;var o=this.model("arrow");if(o.get("visible")){o.set("visible",!1);var n=new t.context.view({parent:this,node:t.context.node&&t.context.node.clone(),data:{uuid:s(),title:t.context.title,viewName:t.context.viewName||t.context.view.name}});n.context=t.context,n.composer=this,o.get("parent").model("components").add(n,o.get("index"))}},onComponentStartDragging:function(t){this.updateComponentsPositions({exclude:t})},onComponentDragging:function(t){this.updateArrow(t.get("position"))},onComponentStopDragging:function(t){this.componentsPositions=null;var o=this.model("arrow");if(o.get("visible")){o.set("visible",!1);var n=o.get("parent"),e=n.model("components"),i=o.get("index");e.indexOf(t)!==i&&(t.parent===n?e.move(t,i):(t.parent.model("components").remove(t),e.add(t,i)))}},validatePasteStartDragging:function(t){17===t.keyCode&&this.onPasteStartDragging(t)},onPasteStartDragging:function(t){this.updateComponentsPositions(),this.listenOn(this.documentBody,"mousemove.onPasteDragging",this.onPasteDragging),this.listenOn(this.documentBody,"keyup.onPasteStopDragging",this.onPasteStopDragging),this.listenOn(this.documentBody,"paste.onPaste",this.onPaste)},onPasteDragging:function(t){this.updateArrow({top:t.pageY,left:t.pageX})},onPasteStopDragging:function(t){17===t.keyCode&&(this.componentsPositions=null,this.model("arrow").set("visible",!1),this.stopListening(this.documentBody,"mousemove.onPasteDragging"),this.stopListening(this.documentBody,"mousemove.onPasteStopDragging"),this.stopListening(this.documentBody,"paste.onPaste"))},onPaste:function(t){var o=this.model("arrow");if(o.get("visible")){try{var e=t.originalEvent.clipboardData.getData("text")}catch(t){return void console.error("clipboardData.getData() error:",t)}try{var i=JSON.parse(e)}catch(t){return void console.error("JSON.parse() error:",t)}var a=o.get("parent").model("components"),r=o.get("index"),s=this.getComponentByUuid(i.uuid),c=n.CUT_KEY,p=localStorage.getItem(c);s&&s.data.uuid===p?this.onComponentStopDragging(s):(s=this.createComponent(i),this.updateComponentUuid(s),a.add(s,r)),localStorage.removeItem(c)}},createComponent:function(t){if(t instanceof Array){var o=this;return t.map(function(t){return o.createComponent(t)}).filter(function(t){return!!t})}var n=this.model("toolbar").find(function(o){return o.viewName===t.viewName||o.view.name===t.viewName});if(!n)return void console.warn("Can't find view with name",t.viewName);var e=t.components;e&&(t.components=[]);var i=new n.view({node:n.node&&n.node.clone(),data:t});return i.composer=this,e&&i.model("components").add(this.createComponent(e)),i},updateComponentUuid:function(t){if(t.data.uuid=s(),t.data.components){var o=this;t.data.components.forEach(function(t){o.updateComponentUuid(t)})}},getComponentByUuid:function(t){function o(n){for(var e=0,i=n.length;e<i;e++){var a=n[e];if(a.data.uuid===t)return a;if(a.data.components)return o(a.data.components)}}return o(this.data.components)},copyComponent:function(t){var o=JSON.stringify(t);this.ui.copyTextarea.appendTo("body").val(o).get(0).select(),document.execCommand("copy"),this.ui.copyTextarea.detach().val("")},cutComponent:function(t){this.copyComponent(t),this.stopListening(this.window,"storage.cutComponent");var o=n.CUT_KEY;localStorage.setItem(o,t.data.uuid),this.listenOn(this.window,"storage.cutComponent",function(n){n=n.originalEvent,n.key===o&&(n.newValue||this.removeComponent(t),this.stopListening(this.window,"storage.cutComponent"))})},cloneComponent:function(t){if(t instanceof Array){var n=this;return t.map(function(t){return n.cloneComponent(t)})}var e=t.context,i=o.extend({},t.data),a=i.components;a&&(i.components=[]);var r=new e.view({context:e,node:e.node&&e.node.clone(),data:i});return r.context=e,r.composer=this,a&&r.model("components").add(this.cloneComponent(a)),r},removeComponent:function(t){t.parent.model("components").remove(t),e.prototype.remove.call(t)},template:{"@arrow":{style:{top:"@arrow.top",left:"@arrow.left",display:{"@arrow.visible":function(t){return t?"block":"none"}}},attr:{"data-direction":"@arrow.direction"}},"@toolbar":{each:{prop:"toolbar",view:function(t,o){return new i({parent:this,node:o,context:t,data:{title:t.title}})}}},"@components":{each:{prop:"components",view:function(t){return t.parent=this,t},node:"> *:nth-child(2)",remove:function(t,o){o.node.detach()}}}}}),t.extend({constructor:e,ui:{dragZone:"@root",dragClone:"[data-drag-clone]"},data:function(){return{dragging:!1,offset:{left:10,top:10},position:{left:0,top:0}}},validateDragging:function(t){1===t.which&&this.onStartDragging(t)},onStartDragging:function(t){this.model("position").set({top:t.pageY-this.data.offset.top,left:t.pageX-this.data.offset.left}),this.ui.dragClone.appendTo(this.documentBody),this.listenOn(this.documentBody,"mousemove.startDragging",this.onDragging),this.listenOn(this.documentBody,"mouseup.startDragging",this.onStopDragging),this.set("dragging",!0)},onDragging:function(t){this.model("position").set({top:t.pageY-this.data.offset.top,left:t.pageX-this.data.offset.left})},onStopDragging:function(){this.ui.dragClone.appendTo(this.node),this.stopListening(this.window,"scroll.startDragging"),this.stopListening(this.documentBody,"mousemove.startDragging"),this.stopListening(this.documentBody,"mouseup.startDragging"),this.set("dragging",!1)},template:function(){var t={},o="@dragClone";return 0===this.ui.dragClone.length&&(o="@root"),t[o]={style:{left:"@position.left",top:"@position.top"}},t}}),e.extend({constructor:i,ui:{title:"[data-title]"},onStartDragging:function(t){e.prototype.onStartDragging.call(this,t),this.parent.onToolbarItemStartDragging(this)},onDragging:function(t){e.prototype.onDragging.call(this,t),this.parent.onToolbarItemDragging(this)},onStopDragging:function(t){e.prototype.onStopDragging.call(this,t),this.parent.onToolbarItemStopDragging(this)},template:{"@title":{text:"=title"}}}),e.extend({constructor:a,ui:{dragZone:"[data-drag-zone]",title:"[data-title]",edit:"[data-edit]",cut:"[data-cut]",copy:"[data-copy]",clone:"[data-clone]",remove:"[data-remove]",collapse:"[data-collapse]",expand:"[data-expand]",content:"[data-content]"},data:{collapsed:!1},onStartDragging:function(t){e.prototype.onStartDragging.call(this,t),this.composer.onComponentStartDragging(this)},onDragging:function(t){e.prototype.onDragging.call(this,t),this.composer.onComponentDragging(this)},onStopDragging:function(t){e.prototype.onStopDragging.call(this,t),this.composer.onComponentStopDragging(this)},collapse:function(){this.set("collapsed",!0)},expand:function(){this.set("collapsed",!1)},copy:function(){this.composer.copyComponent(this)},cut:function(){this.composer.cutComponent(this)},clone:function(){var t=this.composer.cloneComponent(this),o=this.parent.model("components");o.add(t,o.indexOf(this)+1)},remove:function(){this.composer.removeComponent(this)},toJSON:function(){var t=o.extend({},this.data);return t.components&&(t.components=t.components.map(function(t){return t.toJSON()})),t.viewName=t.viewName||this.constructor.name,t},template:{"@root":{toggleClass:{"component-collapsed":"@collapsed"}},"@title":{text:"=title"},"@collapse":{on:{click:"collapse"}},"@expand":{on:{click:"expand"}},"@copy":{on:{click:"copy"}},"@cut":{on:{click:"cut"}},"@clone":{on:{click:"clone"}},"@remove":{on:{click:"remove"}}}}),a.extend({constructor:r,ui:{components:"[data-components]"},data:function(){return{components:[],componentsDirection:"vertical"}},forEachComponent:n.prototype.forEachComponent,remove:function(){return this.forEachComponent(function(t){t.off().stopListening()}),a.prototype.remove.call(this)},template:{"@components":{each:{prop:"components",node:!1,view:function(t){return t.parent=this,t},remove:function(t,o){o.node.detach()}}}}});var s=function(){return window.crypto&&"function"==typeof window.crypto.getRandomValues?function(){var t=new Uint16Array(8);window.crypto.getRandomValues(t);var o=function(t){for(var o=t.toString(16);o.length<4;)o="0"+o;return o};return o(t[0])+o(t[1])+"-"+o(t[2])+"-"+o(t[3])+"-"+o(t[4])+"-"+o(t[5])+o(t[6])+o(t[7])}:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=16*Math.random()|0;return("x"==t?o:3&o|8).toString(16)})}}();return n.Draggable=e,n.ToolbarItem=i,n.Component=a,n.ContainerComponent=r,n});